<# Deploy-SPOT.ps1
Creates the SPOT app folder in Documents, writes SPOT.ps1, and drops a desktop launcher.
#>

$docsPath    = [Environment]::GetFolderPath('MyDocuments')
$desktopPath = [Environment]::GetFolderPath('Desktop')
$spotDir     = Join-Path $docsPath 'SQL Performance Observation Tool'
$spotPath    = Join-Path $spotDir 'SPOT.ps1'
$launcher    = Join-Path $desktopPath 'Launch-SPOT.ps1'

# Ensure target folder exists
New-Item -ItemType Directory -Path $spotDir -Force | Out-Null

# -----------------------------
# Write SPOT.ps1
# -----------------------------
$spotContent = @'
#Requires -Version 5.1
<#
.SYNOPSIS
SQL Performance Observation Tool (SPOT)

.DESCRIPTION
A dashboard for collecting and exploring SQL Server performance snapshots
into utility.SPOT tables via SPOT.CaptureSnapshot.

Features:
- Captures live samples (WhoIsActive, waits, blocking, AG health, etc) on an interval.
- Saves those samples in SQL (utility.SPOT.* tables).
- Lets you browse a chosen snapshot: per-sample view, grid per category.
- Dark theme + consistent styling.
- Sample Timeline slider with per-sample navigation.
- HealthChecks de-duplicated per sample.
- Blocking info called out directly in the WhoIsActive grid.
- Execution plan viewer on demand per row.
- Session Manager: persists multiple connection profiles to disk (Documents\SQL Performance Observation Tool\Sessions.xml),
  supports create/update/delete, and auto-loads + tests last used session.
- Can save/load snapshots to/from JSON files without relying on the database.

.AUTHOR
    Jake Morgan
    Blackcat Data Solutions
    October 2025
#>

Add-Type -AssemblyName System.Windows.Forms
if ([System.Threading.Thread]::CurrentThread.ApartmentState -ne 'STA') {
    [System.Windows.Forms.MessageBox]::Show(
        "Restarting SPOT in STA mode for the GUI...",
        "SPOT",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    ) | Out-Null
    Start-Process powershell -ArgumentList "-NoProfile -ExecutionPolicy Bypass -STA -File `"$PSCommandPath`"" -WindowStyle Hidden
    exit
}
if ($PSVersionTable.PSVersion -lt [Version]"5.1") {
    [System.Windows.Forms.MessageBox]::Show(
        "PowerShell 5.1 or higher is required. Current: $($PSVersionTable.PSVersion)",
        "SPOT prerequisite",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Error
    ) | Out-Null
    exit 1
}

Add-Type -AssemblyName System.Data
Add-Type -AssemblyName System.Drawing
Add-Type -AssemblyName System.Windows.Forms

# =======================
# SESSION STORAGE SETUP
# =======================
$script:SpotRootFolder   = Join-Path $env:USERPROFILE "Documents\SQL Performance Observation Tool"
$script:SessionsFilePath = Join-Path $script:SpotRootFolder "Sessions.xml"

# We will *always* hold sessions as a mutable ArrayList
$script:Sessions = New-Object System.Collections.ArrayList
$script:CurrentSessionName = $null  # track which session is "current" in UI

# runtime global state
$script:loadedSnapshotData   = $null
$script:sortState            = @{}
$script:dataGrids            = @{}
$script:timelineLabels       = @()
$script:isUpdatingTimeline   = $false

# app meta
$script:SpotVersion = "- SQL Performance Observation Tool - v0.9.0-preview"
$script:SpotAuthor  = "Jake Morgan @ Blackcat Data Solutions Limited © 2025"
$script:SpotLogoBase64Png = "data:image/png;base64,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"

function Ensure-SessionsStorage {
    if (-not (Test-Path $script:SpotRootFolder)) {
        New-Item -ItemType Directory -Path $script:SpotRootFolder -Force | Out-Null
    }
    if (-not (Test-Path $script:SessionsFilePath)) {
        $blank = [pscustomobject]@{
            LastSession = ""
            Sessions    = @()
        }
        $blank | Export-Clixml -Path $script:SessionsFilePath
    }
}

function Convert-ToArrayList {
    param($items)

    $list = New-Object System.Collections.ArrayList
    if ($null -eq $items) { return $list }

    if ($items -is [System.Collections.IEnumerable] -and
        -not ($items -is [string])) {

        foreach ($i in $items) { [void]$list.Add($i) }
    }
    else {
        # single object case
        [void]$list.Add($items)
    }

    return $list
}

function Load-AllSessions {
    Ensure-SessionsStorage
    try {
        $data = Import-Clixml -Path $script:SessionsFilePath

        # rebuild ArrayList of sessions
        $script:Sessions = New-Object System.Collections.ArrayList
        if ($data.Sessions) {
            $tmpList = Convert-ToArrayList $data.Sessions
            foreach ($s in $tmpList) {
                # normalise
                $null = $script:Sessions.Add(
                    [pscustomobject]@{
                        Name     = $s.Name
                        Server   = $s.Server
                        Username = $s.Username
                        Password = $s.Password
                    }
                )
            }
        }

        $script:CurrentSessionName = $data.LastSession
    }
    catch {
        # corrupt / missing etc.
        $script:Sessions = New-Object System.Collections.ArrayList
        $script:CurrentSessionName = $null
    }
}

function Save-AllSessions {
    Ensure-SessionsStorage

    # serialisable plain array rather than ArrayList
    $plainSessions = @()
    foreach ($s in $script:Sessions) {
        $plainSessions += [pscustomobject]@{
            Name     = $s.Name
            Server   = $s.Server
            Username = $s.Username
            Password = $s.Password
        }
    }

    $outObj = [pscustomobject]@{
        LastSession = $script:CurrentSessionName
        Sessions    = $plainSessions
    }
    $outObj | Export-Clixml -Path $script:SessionsFilePath
}

function Get-SessionByName {
    param([string]$Name)
    foreach ($sess in $script:Sessions) {
        if ($sess.Name -eq $Name) { return $sess }
    }
    return $null
}

function Ensure-SessionsArrayList {
    # if someone somehow replaced it with a PSCustomObject or $null,
    # re-wrap it as ArrayList
    if (-not ($script:Sessions -is [System.Collections.ArrayList])) {
        $script:Sessions = Convert-ToArrayList $script:Sessions
    }
}

function Upsert-Session {
    param(
        [string]$Name,
        [string]$Server,
        [string]$Username,
        [securestring]$Password
    )

    Ensure-SessionsArrayList

    $existing = Get-SessionByName -Name $Name
    if ($existing) {
        $existing.Server   = $Server
        $existing.Username = $Username
        $existing.Password = $Password
    } else {
        $null = $script:Sessions.Add(
            [pscustomobject]@{
                Name     = $Name
                Server   = $Server
                Username = $Username
                Password = $Password
            }
        )
    }

    $script:CurrentSessionName = $Name
    Save-AllSessions
}

function Remove-SessionByName {
    param([string]$Name)

    if ([string]::IsNullOrWhiteSpace($Name)) { return }

    Ensure-SessionsArrayList

    # rebuild without the deleted one
    $newList = New-Object System.Collections.ArrayList
    foreach ($sess in $script:Sessions) {
        if ($sess.Name -ne $Name) {
            $null = $newList.Add($sess)
        }
    }
    $script:Sessions = $newList

    if ($script:CurrentSessionName -eq $Name) {
        $script:CurrentSessionName = $null
    }

    Save-AllSessions
}

function Set-UiFromSession {
    param([pscustomobject]$session)

    if (-not $session) { return }

    $serverTextBox.Text    = $session.Server
    $usernameTextBox.Text  = $session.Username
    $passwordTextBox.Tag   = $session.Password
    $passwordTextBox.Text  = '••••••••••'

    $connectionStatusLabel.Text = "Status: Not Connected"
    $connectionStatusLabel.ForeColor = $fgSecondary
    $captureButton.Enabled = $false
}

function Load-LastSessionToUi {
    if ([string]::IsNullOrWhiteSpace($script:CurrentSessionName)) { return }
    $sess = Get-SessionByName -Name $script:CurrentSessionName
    if ($sess) {
        Log-Message "Loaded last session '$($sess.Name)'."
        Set-UiFromSession -session $sess
        $currentSessionValue.Text = $sess.Name
        if ($sessionComboBox.Visible) {
            $sessionComboBox.SelectedItem = $sess.Name
        }
        Invoke-ConnectionTest
    }
}

function Load-SavedConnection {
    # legacy import from $PSScriptRoot\config.xml
    $legacyFile = Join-Path $PSScriptRoot 'config.xml'
    if (-not (Test-Path $legacyFile)) { return }

    try {
        $credential = Import-CliXml -Path $legacyFile
        $user, $server = $credential.UserName.Split('@')

        Log-Message "Importing legacy config.xml as session 'Legacy'."
        Upsert-Session -Name "Legacy" `
            -Server $server `
            -Username $user `
            -Password $credential.Password
    }
    catch {
        Log-Message "Could not import legacy config.xml. File may be corrupt."
    }
}

# =======================
# THEME
# =======================
$bgMain        = [System.Drawing.ColorTranslator]::FromHtml("#1e1e1e")
$bgPanel       = [System.Drawing.ColorTranslator]::FromHtml("#252526")
$bgPanelBorder = [System.Drawing.ColorTranslator]::FromHtml("#3f3f46")

$fgPrimary     = [System.Drawing.ColorTranslator]::FromHtml("#d4d4d4")
$fgSecondary   = [System.Drawing.ColorTranslator]::FromHtml("#9ca3af")
$fgAccent      = [System.Drawing.ColorTranslator]::FromHtml("#ffffff")
$fgWarn        = [System.Drawing.ColorTranslator]::FromHtml("#ffd700")

$accentBlue    = [System.Drawing.ColorTranslator]::FromHtml("#0e639c")
$btnGray       = [System.Drawing.ColorTranslator]::FromHtml("#3a3d41")

$gridHeaderBg  = [System.Drawing.ColorTranslator]::FromHtml("#2d2d30")
$gridHeaderFg  = $fgAccent
$gridRowBg     = [System.Drawing.ColorTranslator]::FromHtml("#1e1e1e")
$gridRowSelBg  = [System.Drawing.ColorTranslator]::FromHtml("#094771")
$gridRowSelFg  = $fgAccent
$gridLines     = [System.Drawing.ColorTranslator]::FromHtml("#3f3f46")
$blockingRed   = [System.Drawing.ColorTranslator]::FromHtml("#b00020")

$consoleBack   = [System.Drawing.ColorTranslator]::FromHtml("#1a1a1a")
$consoleFore   = [System.Drawing.ColorTranslator]::FromHtml("#d4d4d4")

$timelineActiveText = $fgWarn

$fontRegular = New-Object System.Drawing.Font("Segoe UI", 9, [System.Drawing.FontStyle]::Regular)
$fontBold    = New-Object System.Drawing.Font("Segoe UI", 9, [System.Drawing.FontStyle]::Bold)

# =======================
# MAIN FORM
# =======================
$mainForm = New-Object System.Windows.Forms.Form
$mainForm.Text = "SQL Performance Observation Tool"
$mainForm.Size = New-Object System.Drawing.Size(1200, 800)
$mainForm.MinimumSize = New-Object System.Drawing.Size(800, 600)
$mainForm.StartPosition = "CenterScreen"
$mainForm.FormBorderStyle = "Sizable"
$mainForm.BackColor = $bgMain
$mainForm.ForeColor = $fgPrimary
$mainForm.Font = $fontRegular

# =======================
# MENU BAR
# =======================
$menuStrip = New-Object System.Windows.Forms.MenuStrip
$menuStrip.BackColor = $bgPanel
$menuStrip.ForeColor = $fgPrimary

$fileMenu      = New-Object System.Windows.Forms.ToolStripMenuItem("File")
$miStartCap    = New-Object System.Windows.Forms.ToolStripMenuItem("Start Capture")
$miLoadFromDB  = New-Object System.Windows.Forms.ToolStripMenuItem("Load Snapshot from DB")
$miLoadFromFile= New-Object System.Windows.Forms.ToolStripMenuItem("Load Snapshot from File")
$miSaveToFile  = New-Object System.Windows.Forms.ToolStripMenuItem("Save Snapshot to File")
$miExit        = New-Object System.Windows.Forms.ToolStripMenuItem("Exit")

[void]$fileMenu.DropDownItems.AddRange(@(
    $miStartCap,
    $miLoadFromDB,
    $miLoadFromFile,
    $miSaveToFile,
    (New-Object System.Windows.Forms.ToolStripSeparator),
    $miExit
))

$helpMenu      = New-Object System.Windows.Forms.ToolStripMenuItem("Help")
$miHowTo       = New-Object System.Windows.Forms.ToolStripMenuItem("How to guide")
$miAbout       = New-Object System.Windows.Forms.ToolStripMenuItem("About")

[void]$helpMenu.DropDownItems.AddRange(@(
    $miHowTo,
    $miAbout
))

[void]$menuStrip.Items.AddRange(@($fileMenu,$helpMenu))
$mainForm.MainMenuStrip = $menuStrip
$mainForm.Controls.Add($menuStrip)

# =======================
# DARK GROUPBOX CREATOR
# =======================
function New-DarkGroupBox {
    param(
        [string]$text,
        [System.Drawing.Point]$location,
        [System.Drawing.Size]$size,
        [string]$anchor = "Top, Left"
    )
    $gb = New-Object System.Windows.Forms.GroupBox
    $gb.Text = $text
    $gb.Location = $location
    $gb.Size = $size
    $gb.Anchor = $anchor
    $gb.ForeColor = $fgPrimary
    $gb.BackColor = $bgPanel
    return $gb
}

# =======================
# CONNECTION DETAILS BOX
# =======================
$connectionGroupBox = New-DarkGroupBox -text "Connection Details" `
    -location ([System.Drawing.Point]::new(20,50)) `
    -size     ([System.Drawing.Size]::new(300,270)) `
    -anchor   "Top, Left"
$mainForm.Controls.Add($connectionGroupBox)

$sessionSelectLabel = New-Object System.Windows.Forms.Label
$sessionSelectLabel.Text = "Session:"
$sessionSelectLabel.Location = New-Object System.Drawing.Point(10, 30)
$sessionSelectLabel.AutoSize = $true
$sessionSelectLabel.ForeColor = $fgPrimary

$sessionComboBox = New-Object System.Windows.Forms.ComboBox
$sessionComboBox.Location = New-Object System.Drawing.Point(120, 27)
$sessionComboBox.Size = New-Object System.Drawing.Size(160,20)
$sessionComboBox.DropDownStyle = 'DropDownList'
$sessionComboBox.BackColor = $gridRowBg
$sessionComboBox.ForeColor = $fgPrimary
$sessionComboBox.FlatStyle = 'Flat'
$sessionComboBox.Visible = $true       # keep visible even if empty now
$sessionSelectLabel.Visible = $true    # ditto

$serverLabel = New-Object System.Windows.Forms.Label
$serverLabel.Text = "Server/Instance:"
$serverLabel.Location = New-Object System.Drawing.Point(10, 60)
$serverLabel.AutoSize = $true
$serverLabel.ForeColor = $fgPrimary

$serverTextBox = New-Object System.Windows.Forms.TextBox
$serverTextBox.Location = New-Object System.Drawing.Point(120, 57)
$serverTextBox.Size = New-Object System.Drawing.Size(160, 20)
$serverTextBox.BackColor = $gridRowBg
$serverTextBox.ForeColor = $fgPrimary
$serverTextBox.BorderStyle = 'FixedSingle'

$usernameLabel = New-Object System.Windows.Forms.Label
$usernameLabel.Text = "Username:"
$usernameLabel.Location = New-Object System.Drawing.Point(10, 90)
$usernameLabel.AutoSize = $true
$usernameLabel.ForeColor = $fgPrimary

$usernameTextBox = New-Object System.Windows.Forms.TextBox
$usernameTextBox.Location = New-Object System.Drawing.Point(120, 87)
$usernameTextBox.Size = New-Object System.Drawing.Size(160, 20)
$usernameTextBox.BackColor = $gridRowBg
$usernameTextBox.ForeColor = $fgPrimary
$usernameTextBox.BorderStyle = 'FixedSingle'

$passwordLabel = New-Object System.Windows.Forms.Label
$passwordLabel.Text = "Password:"
$passwordLabel.Location = New-Object System.Drawing.Point(10, 120)
$passwordLabel.AutoSize = $true
$passwordLabel.ForeColor = $fgPrimary

$passwordTextBox = New-Object System.Windows.Forms.TextBox
$passwordTextBox.Location = New-Object System.Drawing.Point(120, 117)
$passwordTextBox.Size = New-Object System.Drawing.Size(160, 20)
$passwordTextBox.UseSystemPasswordChar = $true
$passwordTextBox.BackColor = $gridRowBg
$passwordTextBox.ForeColor = $fgPrimary
$passwordTextBox.BorderStyle = 'FixedSingle'

$testConnectionButton = New-Object System.Windows.Forms.Button
$testConnectionButton.Text = "Test"
$testConnectionButton.Location = New-Object System.Drawing.Point(10, 160)
$testConnectionButton.Size = New-Object System.Drawing.Size(80, 30)
$testConnectionButton.BackColor = $btnGray
$testConnectionButton.ForeColor = $fgPrimary
$testConnectionButton.FlatStyle = "Flat"

$saveConnectionButton = New-Object System.Windows.Forms.Button
$saveConnectionButton.Text = "Save"
$saveConnectionButton.Location = New-Object System.Drawing.Point(100, 160)
$saveConnectionButton.Size = New-Object System.Drawing.Size(80, 30)
$saveConnectionButton.BackColor = $btnGray
$saveConnectionButton.ForeColor = $fgPrimary
$saveConnectionButton.FlatStyle = "Flat"

$deleteSessionButton = New-Object System.Windows.Forms.Button
$deleteSessionButton.Text = "🗑 Delete"
$deleteSessionButton.Location = New-Object System.Drawing.Point(190, 160)
$deleteSessionButton.Size = New-Object System.Drawing.Size(80, 30)
$deleteSessionButton.BackColor = $btnGray
$deleteSessionButton.ForeColor = $blockingRed # $fgPrimary
$deleteSessionButton.FlatStyle = "Flat"
$deleteSessionButton.Font = New-Object System.Drawing.Font("Segoe UI Emoji", 9, [System.Drawing.FontStyle]::Regular)

$connectionStatusLabel = New-Object System.Windows.Forms.Label
$connectionStatusLabel.Text = "Status: Not Connected"
$connectionStatusLabel.Location = New-Object System.Drawing.Point(10, 200)
$connectionStatusLabel.AutoSize = $true
$connectionStatusLabel.ForeColor = $fgSecondary

$currentSessionLabel = New-Object System.Windows.Forms.Label
$currentSessionLabel.Text = "Current Session:"
$currentSessionLabel.Location = New-Object System.Drawing.Point(10, 225)
$currentSessionLabel.AutoSize = $true
$currentSessionLabel.ForeColor = $fgPrimary

$currentSessionValue = New-Object System.Windows.Forms.Label
$currentSessionValue.Text = "(none)"
$currentSessionValue.Location = New-Object System.Drawing.Point(120, 225)
$currentSessionValue.AutoSize = $true
$currentSessionValue.ForeColor = $fgPrimary

$utilityDbLabel = New-Object System.Windows.Forms.Label
#$utilityDbLabel.Text = "Target DB:"
$utilityDbLabel.Location = New-Object System.Drawing.Point(10, 245)
$utilityDbLabel.AutoSize = $true
$utilityDbLabel.ForeColor = $fgPrimary

$utilityDbValue = New-Object System.Windows.Forms.Label
#$utilityDbValue.Text = "utility"
$utilityDbValue.Location = New-Object System.Drawing.Point(120, 245)
$utilityDbValue.AutoSize = $true
$utilityDbValue.ForeColor = $fgPrimary

$connectionGroupBox.Controls.AddRange(@(
    $sessionSelectLabel, $sessionComboBox,
    $serverLabel, $serverTextBox,
    $usernameLabel, $usernameTextBox,
    $passwordLabel, $passwordTextBox,
    $testConnectionButton, $saveConnectionButton, $deleteSessionButton,
    $connectionStatusLabel, $currentSessionLabel, $currentSessionValue,
    $utilityDbLabel, $utilityDbValue
))

# =======================
# SNAPSHOT CONFIG BOX
# =======================
$snapshotGroupBox = New-DarkGroupBox -text "Snapshot Configuration" `
    -location ([System.Drawing.Point]::new(20,330)) `
    -size     ([System.Drawing.Size]::new(300,300)) `
    -anchor   "Top, Left"
$mainForm.Controls.Add($snapshotGroupBox)

$sampleRateLabel = New-Object System.Windows.Forms.Label
$sampleRateLabel.Text = "Sample Interval (s):"
$sampleRateLabel.Location = New-Object System.Drawing.Point(10, 30)
$sampleRateLabel.AutoSize = $true
$sampleRateLabel.ForeColor = $fgPrimary

$sampleRateValueLabel = New-Object System.Windows.Forms.Label
$sampleRateValueLabel.Location = New-Object System.Drawing.Point(260, 30)
$sampleRateValueLabel.AutoSize = $true
$sampleRateValueLabel.ForeColor = $fgAccent

$sampleRateSlider = New-Object System.Windows.Forms.TrackBar
$sampleRateSlider.Location = New-Object System.Drawing.Point(120, 25)
$sampleRateSlider.Size = New-Object System.Drawing.Size(140, 45)
$sampleRateSlider.Minimum = 5
$sampleRateSlider.Maximum = 12
$sampleRateSlider.Value = 5
$sampleRateSlider.TickStyle = 'BottomRight'
$sampleRateSlider.BackColor = $bgPanel
$sampleRateValueLabel.Text = $sampleRateSlider.Value

$numSamplesLabel = New-Object System.Windows.Forms.Label
$numSamplesLabel.Text = "Number of Samples:"
$numSamplesLabel.Location = New-Object System.Drawing.Point(10, 80)
$numSamplesLabel.AutoSize = $true
$numSamplesLabel.ForeColor = $fgPrimary

$numSamplesValueLabel = New-Object System.Windows.Forms.Label
$numSamplesValueLabel.Location = New-Object System.Drawing.Point(260, 80)
$numSamplesValueLabel.AutoSize = $true
$numSamplesValueLabel.ForeColor = $fgAccent

$numSamplesSlider = New-Object System.Windows.Forms.TrackBar
$numSamplesSlider.Location = New-Object System.Drawing.Point(120, 75)
$numSamplesSlider.Size = New-Object System.Drawing.Size(140, 45)
$numSamplesSlider.Minimum = 1
$numSamplesSlider.Maximum = 20
$numSamplesSlider.Value = 3
$numSamplesSlider.TickStyle = 'BottomRight'
$numSamplesSlider.BackColor = $bgPanel
$numSamplesValueLabel.Text = $numSamplesSlider.Value

$captureButton = New-Object System.Windows.Forms.Button
$captureButton.Text = "Start Capture"
$captureButton.Location = New-Object System.Drawing.Point(10, 120)
$captureButton.Size = New-Object System.Drawing.Size(280, 40)
$captureButton.BackColor = $accentBlue
$captureButton.ForeColor = $fgAccent
$captureButton.FlatStyle = "Flat"
$captureButton.Enabled = $false

$loadSnapshotButton = New-Object System.Windows.Forms.Button
$loadSnapshotButton.Text = "Load Snapshot from DB"
$loadSnapshotButton.Location = New-Object System.Drawing.Point(10, 165)
$loadSnapshotButton.Size = New-Object System.Drawing.Size(280, 25)
$loadSnapshotButton.BackColor = $btnGray
$loadSnapshotButton.ForeColor = $fgPrimary
$loadSnapshotButton.FlatStyle = "Flat"

# NEW: Save Snapshot to File
$saveSnapshotToFileButton = New-Object System.Windows.Forms.Button
$saveSnapshotToFileButton.Text = "Save Snapshot to File"
$saveSnapshotToFileButton.Location = New-Object System.Drawing.Point(10, 195)
$saveSnapshotToFileButton.Size = New-Object System.Drawing.Size(280, 25)
$saveSnapshotToFileButton.BackColor = $btnGray
$saveSnapshotToFileButton.ForeColor = $fgPrimary
$saveSnapshotToFileButton.FlatStyle = "Flat"

# NEW: Load Snapshot from File
$loadSnapshotFromFileButton = New-Object System.Windows.Forms.Button
$loadSnapshotFromFileButton.Text = "Load Snapshot from File"
$loadSnapshotFromFileButton.Location = New-Object System.Drawing.Point(10, 225)
$loadSnapshotFromFileButton.Size = New-Object System.Drawing.Size(280, 25)
$loadSnapshotFromFileButton.BackColor = $btnGray
$loadSnapshotFromFileButton.ForeColor = $fgPrimary
$loadSnapshotFromFileButton.FlatStyle = "Flat"

$snapshotGroupBox.Controls.AddRange(@(
    $sampleRateLabel, $sampleRateValueLabel, $sampleRateSlider,
    $numSamplesLabel, $numSamplesValueLabel, $numSamplesSlider,
    $captureButton, $loadSnapshotButton,
    $saveSnapshotToFileButton, $loadSnapshotFromFileButton
))

# =======================
# CONSOLE LOG
# =======================
$consoleGroupBox = New-DarkGroupBox -text "Console Log" `
    -location ([System.Drawing.Point]::new(340,50)) `
    -size     ([System.Drawing.Size]::new(820,140)) `
    -anchor   "Top, Left, Right"
$mainForm.Controls.Add($consoleGroupBox)

$consoleLogTextBox = New-Object System.Windows.Forms.TextBox
$consoleLogTextBox.Location = New-Object System.Drawing.Point(10, 20)
$consoleLogTextBox.Size = New-Object System.Drawing.Size(800, 110)
$consoleLogTextBox.Multiline = $true
$consoleLogTextBox.ScrollBars = "Vertical"
$consoleLogTextBox.ReadOnly = $true
$consoleLogTextBox.BackColor = $consoleBack
$consoleLogTextBox.ForeColor = $consoleFore
$consoleLogTextBox.BorderStyle = 'FixedSingle'
$consoleLogTextBox.Anchor = "Top, Bottom, Left, Right"
$consoleGroupBox.Controls.Add($consoleLogTextBox)

# =======================
# SAMPLE TIMELINE
# =======================
$timelineGroupBox = New-DarkGroupBox -text "Sample Timeline:" `
    -location ([System.Drawing.Point]::new(340,200)) `
    -size     ([System.Drawing.Size]::new(820,150)) `
    -anchor   "Top, Left, Right"
$timelineGroupBox.Visible = $false
$mainForm.Controls.Add($timelineGroupBox)

$timelineTrackBar = New-Object System.Windows.Forms.TrackBar
$timelineTrackBar.Location     = New-Object System.Drawing.Point(10, 40)
$timelineTrackBar.Size         = New-Object System.Drawing.Size(800, 45)
$timelineTrackBar.Minimum      = 0
$timelineTrackBar.Maximum      = 0
$timelineTrackBar.TickFrequency = 1
$timelineTrackBar.SmallChange   = 1
$timelineTrackBar.LargeChange   = 1
$timelineTrackBar.TickStyle     = 'BottomRight'
$timelineTrackBar.BackColor     = $bgPanel
$timelineTrackBar.Enabled       = $false
$timelineTrackBar.AutoSize      = $false
$timelineTrackBar.Height        = 45
$timelineTrackBar.Anchor        = "Top, Left, Right"
$timelineGroupBox.Controls.Add($timelineTrackBar)

# =======================
# RESULTS TABCONTROL
# =======================
$resultsTabControl = New-Object System.Windows.Forms.TabControl
$resultsTabControl.Location = New-Object System.Drawing.Point(340,360)
$resultsTabControl.Size = New-Object System.Drawing.Size(820, 400)
$resultsTabControl.Visible = $false
$resultsTabControl.Anchor = "Top, Bottom, Left, Right"
$resultsTabControl.BackColor = $bgPanel
$resultsTabControl.ForeColor = $fgPrimary
$mainForm.Controls.Add($resultsTabControl)

# =======================
# CONTEXT MENU FOR GRIDS
# =======================
$gridContextMenu = New-Object System.Windows.Forms.ContextMenuStrip
$menuCopyRow     = New-Object System.Windows.Forms.ToolStripMenuItem("Copy Row to Clipboard")
$menuViewPlan    = New-Object System.Windows.Forms.ToolStripMenuItem("View Execution Plan")
[void]$gridContextMenu.Items.Add($menuCopyRow)
[void]$gridContextMenu.Items.Add($menuViewPlan)

# =======================
# HELPERS
# =======================
function Log-Message {
    param([string]$Message)
    $consoleLogTextBox.AppendText("$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $Message`r`n")
    $consoleLogTextBox.Update()
}

function Get-PasswordFromTextBox {
    if ($passwordTextBox.Tag -is [System.Security.SecureString]) {
        $bstr = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($passwordTextBox.Tag)
        $password = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($bstr)
        [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)
        return $password
    } else {
        return $passwordTextBox.Text
    }
}

function Apply-DarkModeToGrid {
    param([System.Windows.Forms.DataGridView]$grid)

    $grid.EnableHeadersVisualStyles = $false
    $grid.ColumnHeadersBorderStyle = 'None'
    $grid.RowHeadersVisible = $false

    $headerStyle = New-Object System.Windows.Forms.DataGridViewCellStyle
    $headerStyle.BackColor = $gridHeaderBg
    $headerStyle.ForeColor = $gridHeaderFg
    $headerStyle.Font = New-Object System.Drawing.Font("Segoe UI", 10, [System.Drawing.FontStyle]::Bold)
    $grid.ColumnHeadersDefaultCellStyle = $headerStyle

    $cellStyle = New-Object System.Windows.Forms.DataGridViewCellStyle
    $cellStyle.BackColor = $gridRowBg
    $cellStyle.ForeColor = $fgPrimary
    $cellStyle.SelectionBackColor = $gridRowSelBg
    $cellStyle.SelectionForeColor = $gridRowSelFg
    $grid.DefaultCellStyle = $cellStyle

    $grid.BackgroundColor = $gridRowBg
    $grid.GridColor = $gridLines
    $grid.BorderStyle = 'None'

    $grid.ContextMenuStrip = $gridContextMenu
    $grid.ReadOnly = $true
    $grid.SelectionMode = "FullRowSelect"
    $grid.MultiSelect = $false
    $grid.Font = $fontRegular
}

function Highlight-WhoIsActiveRows {
    param([System.Windows.Forms.DataGridView]$grid)

    $redStyle = New-Object System.Windows.Forms.DataGridViewCellStyle
    $redStyle.BackColor = $blockingRed
    $redStyle.ForeColor = $fgAccent
    $redStyle.SelectionBackColor = $blockingRed
    $redStyle.SelectionForeColor = $fgAccent

    $longWaitThresholdMs = 1000

    foreach ($row in $grid.Rows) {
        $data = $row.DataBoundItem
        if ($null -eq $data) { continue }

        $isProblem = $false

        if ($data.'Blocking Info' -and $data.'Blocking Info'.Trim() -ne "") {
            $isProblem = $true
        }

        if (-not $isProblem -and $data.wait_info -and $data.wait_info -notmatch 'WAITFOR') {
            if ($data.wait_info -match '\((\d+)ms\)') {
                $waitMs = [int]$Matches[1]
                if ($waitMs -gt $longWaitThresholdMs) {
                    $isProblem = $true
                }
            }
        }

        if ($isProblem) {
            $row.DefaultCellStyle = $redStyle
        }
    }
}

function Format-Datetime2Literal {
    param([datetime]$dt)
    "'{0}'" -f $dt.ToString('yyyy-MM-ddTHH:mm:ss.fff')
}

function Test-HasValue {
    param($v)
    if ($null -eq $v) { return $false }
    if ($v -is [System.DBNull]) { return $false }
    if ($v -is [int] -and $v -eq 0) { return $false }
    if ($v -is [string]) {
        if ($v.Trim() -eq "") { return $false }
        if ($v -eq "0") { return $false }
    }
    return $true
}

# =======================
# TAB + GRID BUILD
# =======================
function On-GridDataBindingComplete {
    param($sender, $e)
    $grid = $sender
    foreach ($column in $grid.Columns) {
        switch ($column.Name) {
            'sql_text'          { $column.AutoSizeMode = 'None'; $column.Width = 260; break }
            'waiting_query'     { $column.AutoSizeMode = 'None'; $column.Width = 260; break }
            'blocking_query'    { $column.AutoSizeMode = 'None'; $column.Width = 260; break }
            'Purpose'           { $column.AutoSizeMode = 'None'; $column.Width = 380; break }
            'Check Description' { $column.AutoSizeMode = 'None'; $column.Width = 260; break }
            default             { $column.AutoSizeMode = 'AllCells' }
        }
    }
    if ($grid.Columns["query_plan"]) {
        $grid.Columns["query_plan"].Visible = $false
    }
}

$On_ColumnHeaderClick = {
    param($sender, $e)
    $grid = $sender

    foreach ($column in $grid.Columns) {
        if ($column.Index -ne $e.ColumnIndex) {
            $column.HeaderCell.SortGlyphDirection = 'None'
        }
    }

    $sortProperty = $grid.Columns[$e.ColumnIndex].DataPropertyName
    if (-not $sortProperty) { return }

    $currentDirection = if (
        $script:sortState[$grid.Name] -and
        $script:sortState[$grid.Name].Property -eq $sortProperty
    ) {
        $script:sortState[$grid.Name].Direction
    } else {
        'Ascending'
    }

    $newDirection = if ($currentDirection -eq 'Ascending') { 'Descending' } else { 'Ascending' }

    $data = $grid.DataSource | Sort-Object -Property $sortProperty -Descending:($newDirection -eq 'Descending')
    $grid.DataSource = $null
    $grid.DataSource = [System.Collections.ArrayList]$data

    $grid.Columns[$e.ColumnIndex].HeaderCell.SortGlyphDirection = $newDirection
    $script:sortState[$grid.Name] = @{
        Property  = $sortProperty
        Direction = $newDirection
    }
}

function Build-UiTabsOnce {
    $resultsTabControl.TabPages.Clear()
    $script:dataGrids.Clear()

    $dataTypes = @("WhoIsActive", "HealthChecks", "AGHealth", "WaitStats", "Blocking")
    foreach ($type in $dataTypes) {
        $tabPage = New-Object System.Windows.Forms.TabPage
        $tabPage.Text = $type
        $tabPage.BackColor = $bgPanel
        $tabPage.ForeColor = $fgPrimary
        $tabPage.Font = $fontRegular

        $grid = New-Object System.Windows.Forms.DataGridView
        $grid.Name = $type
        $grid.Dock = "Fill"
        $grid.AutoSizeColumnsMode = "None"
        $grid.AllowUserToResizeColumns = $true

        Apply-DarkModeToGrid -grid $grid

        $grid.add_ColumnHeaderMouseClick($On_ColumnHeaderClick)
        $grid.add_DataBindingComplete({ param($s,$e) On-GridDataBindingComplete -sender $s -e $e })

        if ($type -eq 'WhoIsActive') {
            $grid.add_DataBindingComplete({
                param($s,$e)
                if ($this.Columns["Blocking Info"]) {
                    $this.Columns["Blocking Info"].DisplayIndex = 0
                }
                if ($this.Columns["query_plan"]) {
                    $this.Columns["query_plan"].Visible = $false
                }
                Highlight-WhoIsActiveRows -grid $this
            })
        }

        $tabPage.Controls.Add($grid)
        $resultsTabControl.TabPages.Add($tabPage)
        $script:dataGrids[$type] = $grid
    }
}

function Bind-SampleToGrids {
    param($selectedSample)

    foreach ($key in $script:dataGrids.Keys) {
        $grid = $script:dataGrids[$key]
        $data = $selectedSample.$key

        $bindableData = New-Object System.Collections.ArrayList
        if ($data) {
            if ($data -is [array]) {
                $bindableData.AddRange($data)
            } else {
                $bindableData.Add($data)
            }
        }

        if ($key -eq 'WaitStats' -and $data) {
            $bindableData = [System.Collections.ArrayList]($data | Sort-Object -Property 'wait_time_ms' -Descending)
        }

        $grid.DataSource = $null
        $grid.DataSource = $bindableData
    }
}

# =======================
# TIMELINE LABEL HANDLING
# =======================
$script:timelineLabels = @()

function Build-TimelineLabels {
    param(
        [System.Collections.IList]$samples
    )

    foreach ($lbl in $script:timelineLabels) {
        if ($lbl -and -not $lbl.IsDisposed) {
            $timelineGroupBox.Controls.Remove($lbl)
            $lbl.Dispose()
        }
    }
    $script:timelineLabels = @()

    if (-not $samples -or $samples.Count -eq 0) { return }

    $trackLeft   = $timelineTrackBar.Left
    $trackTop    = $timelineTrackBar.Top
    $trackWidth  = $timelineTrackBar.Width
    $knobFudge   = [int]16
    $labelY      = $trackTop + $timelineTrackBar.Height + 5

    $count = $samples.Count
    for ($i=0; $i -lt $count; $i++) {
        $sampleNum = $samples[$i].SampleNumber.ToString()

        if ($count -gt 1) {
            $pct = $i / [double]($count - 1)
        } else {
            $pct = 0.0
        }
        $xOffset = [int]( ($trackWidth - $knobFudge) * $pct )
        $labelX  = $trackLeft + $xOffset

        $lbl = New-Object System.Windows.Forms.Label
        $lbl.Text      = $sampleNum
        $lbl.AutoSize  = $true
        $lbl.ForeColor = $fgPrimary
        $lbl.BackColor = $bgPanel
        $lbl.Font      = $fontRegular
        $lbl.Cursor    = [System.Windows.Forms.Cursors]::Hand
        $lbl.Tag       = $i
        $lbl.Location  = New-Object System.Drawing.Point($labelX,$labelY)

        $lbl.Add_Click({
            param($sender,$args)
            $idx = [int]$sender.Tag
            $script:isUpdatingTimeline = $true
            $timelineTrackBar.Value = $idx
            $script:isUpdatingTimeline = $false
            Set-TimelineIndex -index $idx
        })

        $timelineGroupBox.Controls.Add($lbl)
        $script:timelineLabels += $lbl
    }
}

function Update-TimelineLabelHighlight {
    param([int]$index)

    for ($i=0; $i -lt $script:timelineLabels.Count; $i++) {
        $lbl = $script:timelineLabels[$i]
        if ($null -eq $lbl -or $lbl.IsDisposed) { continue }

        if ($i -eq $index) {
            $lbl.ForeColor = $timelineActiveText
            $lbl.Font      = $fontBold
        } else {
            $lbl.ForeColor = $fgPrimary
            $lbl.Font      = $fontRegular
        }
    }
}

function Set-TimelineIndex {
    param([int]$index)

    if ($script:loadedSnapshotData -and
        $script:loadedSnapshotData.Samples -and
        $index -ge 0 -and
        $index -lt $script:loadedSnapshotData.Samples.Count) {

        $selectedSample = $script:loadedSnapshotData.Samples[$index]
        $sampleNumber   = $selectedSample.SampleNumber
        $stampDisplay   = [datetime]$selectedSample.Timestamp | Get-Date -Format 'yyyy-MM-dd HH:mm:ss'

        Log-Message "Loading Sample $sampleNumber ($stampDisplay)..."

        $mainForm.Cursor = [System.Windows.Forms.Cursors]::WaitCursor
        try {
            Bind-SampleToGrids -selectedSample $selectedSample
            Update-TimelineLabelHighlight -index $index

            $timelineGroupBox.Text = "Sample Timeline: $stampDisplay"
        }
        finally {
            Log-Message "Loaded Sample $sampleNumber."
            $mainForm.Cursor = [System.Windows.Forms.Cursors]::Default
        }
    }
}

# =======================
# SNAPSHOT SAVE / LOAD (FILE)
# =======================
function Save-SnapshotToFile {
    if (-not $script:loadedSnapshotData) {
        [System.Windows.Forms.MessageBox]::Show(
            "No snapshot is currently loaded.",
            "SPOT",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Information
        ) | Out-Null
        return
    }

    $dlg = New-Object System.Windows.Forms.SaveFileDialog
    $dlg.Title = "Save Snapshot As"
    $dlg.Filter = "JSON Files (*.json)|*.json|All Files (*.*)|*.*"
    $dlg.FileName = ("SPOT_Snapshot_{0}.json" -f (Get-Date -Format "yyyyMMdd_HHmmss"))

    if ($dlg.ShowDialog() -eq 'OK') {
        try {
            # serialise with depth
            $json = $script:loadedSnapshotData | ConvertTo-Json -Depth 6
            [IO.File]::WriteAllText($dlg.FileName, $json, [Text.Encoding]::UTF8)
            Log-Message "Snapshot saved to file: $($dlg.FileName)"
        }
        catch {
            Log-Message "ERROR: Failed to save snapshot to file. $($_.Exception.Message)"
            [System.Windows.Forms.MessageBox]::Show(
                "Failed to save snapshot.`r`n$($_.Exception.Message)",
                "SPOT",
                [System.Windows.Forms.MessageBoxButtons]::OK,
                [System.Windows.Forms.MessageBoxIcon]::Error
            ) | Out-Null
        }
    }
}

function Load-SnapshotFromFile {
    $dlg = New-Object System.Windows.Forms.OpenFileDialog
    $dlg.Title = "Open Snapshot File"
    $dlg.Filter = "JSON Files (*.json)|*.json|All Files (*.*)|*.*"

    if ($dlg.ShowDialog() -ne 'OK') { return }

    try {
        $json = [IO.File]::ReadAllText($dlg.FileName, [Text.Encoding]::UTF8)
        $obj  = $json | ConvertFrom-Json

        if (-not $obj.Samples) {
            throw "File does not look like a SPOT snapshot."
        }

        $script:loadedSnapshotData = @{
            Samples = New-Object System.Collections.ArrayList
        }

        # Re-hydrate Samples into ArrayList and normalise inner arrays
        foreach ($s in $obj.Samples) {
            $oneSample = @{
                SampleNumber = $s.SampleNumber
                Timestamp    = $s.Timestamp
                WhoIsActive  = $s.WhoIsActive
                HealthChecks = $s.HealthChecks
                AGHealth     = $s.AGHealth
                WaitStats    = $s.WaitStats
                Blocking     = $s.Blocking
            }
            [void]$script:loadedSnapshotData.Samples.Add($oneSample)
        }

        Build-UiTabsOnce

        $timelineGroupBox.Visible = $true
        $resultsTabControl.Visible = $true

        $count = $script:loadedSnapshotData.Samples.Count
        $timelineTrackBar.Minimum = 0
        $timelineTrackBar.Maximum = [math]::Max(0, $count - 1)
        $timelineTrackBar.TickFrequency = 1
        $timelineTrackBar.SmallChange  = 1
        $timelineTrackBar.LargeChange  = 1
        $timelineTrackBar.Enabled = $true

        Build-TimelineLabels -samples $script:loadedSnapshotData.Samples

        $script:isUpdatingTimeline = $true
        $timelineTrackBar.Value = 0
        $script:isUpdatingTimeline = $false
        Set-TimelineIndex -index 0

        Log-Message "Snapshot loaded from file: $($dlg.FileName)"
    }
    catch {
        Log-Message "ERROR: Failed to load snapshot from file. $($_.Exception.Message)"
        [System.Windows.Forms.MessageBox]::Show(
            "Failed to load snapshot.`r`n$($_.Exception.Message)",
            "SPOT",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Error
        ) | Out-Null
    }
}

# =======================
# SNAPSHOT LOADING FROM DB
# =======================
function Get-SqlData {
    param([string]$ConnectionString, [string]$Query)

    $connection = New-Object System.Data.SqlClient.SqlConnection($ConnectionString)
    $command    = New-Object System.Data.SqlClient.SqlCommand($Query, $connection)
    $command.CommandTimeout = 180
    $adapter  = New-Object System.Data.SqlClient.SqlDataAdapter($command)
    $dataset  = New-Object System.Data.DataSet
    try {
        $connection.Open()
        [void]$adapter.Fill($dataset)
    } catch {
        throw $_
    } finally {
        if ($connection.State -eq 'Open') { $connection.Close() }
    }

    $table = $null
    if ($dataset.Tables.Count -gt 0) {
        $table = ($dataset.Tables | Where-Object { $_.Columns.Count -gt 0 } | Select-Object -Last 1)
    }
    if (-not $table) { return @() }

    $results = New-Object System.Collections.ArrayList
    foreach ($row in $table.Rows) {
        $obj = New-Object -TypeName PSObject
        foreach ($col in $table.Columns) {
            $obj | Add-Member -MemberType NoteProperty -Name $col.ColumnName -Value $row[$col]
        }
        [void]$results.Add($obj)
    }
    return $results
}

function Load-SnapshotById {
    param([string]$ConnectionString, [datetime]$SnapshotId)

    try {
        Log-Message "Loading snapshot $($SnapshotId.ToString('yyyy-MM-dd HH:mm:ss.fff')) from DB..."
        $lit = Format-Datetime2Literal $SnapshotId

        $samples = Get-SqlData -ConnectionString $ConnectionString -Query @"
SELECT SampleId, SampleNumber, CaptureTimestamp
FROM SPOT.Samples
WHERE SnapshotId = $lit
ORDER BY SampleNumber;
"@

        if (-not $samples -or $samples.Count -eq 0) {
            throw "No samples found for SnapshotId $SnapshotId"
        }

        $script:loadedSnapshotData = @{
            Samples = New-Object System.Collections.ArrayList
        }

        Build-UiTabsOnce

        foreach ($s in $samples) {
            $sid = $s.SampleId

            $sampleObj = @{
                SampleNumber = $s.SampleNumber
                Timestamp    = $s.CaptureTimestamp
            }

            $whois = Get-SqlData -ConnectionString $ConnectionString -Query @"
SELECT [dd hh:mm:ss.mss],[session_id],[sql_text],[login_name],[wait_info],[CPU],[tempdb_allocations],[tempdb_current],
       [blocking_session_id],[reads],[writes],[physical_reads],[used_memory],[status],[open_tran_count],[percent_complete],
       [host_name],[database_name],[program_name],[start_time],[login_time],[request_id],[query_plan],[collection_time]
FROM SPOT.WhoIsActive
WHERE SnapshotId = $lit AND SampleId = $sid;
"@

            if ($whois) {
                $leadBlockers = @{}
                foreach ($row in $whois) {
                    $blkBy = $row.blocking_session_id
                    if (Test-HasValue $blkBy) {
                        $parent = $blkBy.ToString()
                        if (-not $leadBlockers.ContainsKey($parent)) {
                            $leadBlockers[$parent] = @()
                        }
                        $leadBlockers[$parent] += $row.session_id.ToString()
                    }
                }

                foreach ($row in $whois) {
                    $sidStr  = $row.session_id.ToString()
                    $blkBy   = $row.blocking_session_id
                    $info    = ""

                    $iAmBlocked = Test-HasValue $blkBy
                    $iAmLead    = $leadBlockers.ContainsKey($sidStr)

                    $blockerIsAlsoBlocked = $false
                    if ($iAmBlocked) {
                        $parentSid = $blkBy.ToString()
                        $parentRow = $whois | Where-Object { $_.session_id.ToString() -eq $parentSid } | Select-Object -First 1
                        if ($parentRow) {
                            $parentBlocker = $parentRow.blocking_session_id
                            if (Test-HasValue $parentBlocker) {
                                $blockerIsAlsoBlocked = $true
                            }
                        }
                    }

                    $iAmAlsoBlocked = $false
                    if ($iAmLead) {
                        $meParentBlocker = $row.blocking_session_id
                        if (Test-HasValue $meParentBlocker) {
                            $iAmAlsoBlocked = $true
                        }
                    }

                    if ($iAmLead) {
                        $info = "LEAD"
                        if ($iAmAlsoBlocked) {
                            $info += " (CHAIN)"
                        }
                    }
                    elseif ($iAmBlocked) {
                        $info = "BLOCKED BY $blkBy"
                        if ($blockerIsAlsoBlocked) {
                            $info += " (CHAIN)"
                        }
                    }
                    else {
                        $info = ""
                    }

                    Add-Member -InputObject $row -MemberType NoteProperty -Name 'Blocking Info' -Value $info -Force
                }
            }
            $sampleObj.WhoIsActive = $whois

            $hcRaw = Get-SqlData -ConnectionString $ConnectionString -Query @"
SELECT [Check Description],[Purpose],[Current Value]
FROM SPOT.HealthChecks
WHERE SnapshotId = $lit AND SampleId = $sid
ORDER BY [Check Description];
"@

            $hcGrouped = @()
            if ($hcRaw) {
                $hcGrouped = $hcRaw |
                    Group-Object -Property 'Check Description','Purpose' |
                    ForEach-Object {
                        $last = $_.Group[-1]
                        [pscustomobject]@{
                            'Check Description' = $last.'Check Description'
                            'Purpose'           = $last.'Purpose'
                            'Current Value'     = $last.'Current Value'
                        }
                    }
            }
            $sampleObj.HealthChecks = $hcGrouped

            $agRaw = Get-SqlData -ConnectionString $ConnectionString -Query @"
SELECT replica_server_name, ag_name, database_name, synchronization_state_desc,
       is_suspended, log_send_queue_size, redo_queue_size
FROM SPOT.AGHealth
WHERE SnapshotId = $lit AND SampleId = $sid;
"@
            if ($agRaw) {
                $agRaw = $agRaw | Select-Object replica_server_name,ag_name,database_name,
                                            synchronization_state_desc,is_suspended,
                                            log_send_queue_size,redo_queue_size -Unique
            }
            $sampleObj.AGHealth = $agRaw

            $wsRaw = Get-SqlData -ConnectionString $ConnectionString -Query @"
SELECT wait_type, waiting_tasks_count, wait_time_ms, max_wait_time_ms, signal_wait_time_ms
FROM SPOT.WaitStats
WHERE SnapshotId = $lit AND SampleId = $sid;
"@
            if ($wsRaw) {
                $wsRaw = $wsRaw | Select-Object wait_type,waiting_tasks_count,wait_time_ms,
                                          max_wait_time_ms,signal_wait_time_ms -Unique
            }
            $sampleObj.WaitStats = $wsRaw

            $blkRaw = Get-SqlData -ConnectionString $ConnectionString -Query @"
SELECT waiting_session_id, blocking_session_id, wait_duration_ms, waiting_query, blocking_query
FROM SPOT.Blocking
WHERE SnapshotId = $lit AND SampleId = $sid;
"@
            if ($blkRaw) {
                $blkRaw = $blkRaw | Select-Object waiting_session_id,blocking_session_id,
                                        wait_duration_ms,waiting_query,blocking_query -Unique
            }
            $sampleObj.Blocking = $blkRaw

            $null = $script:loadedSnapshotData.Samples.Add($sampleObj)
        }

        $timelineGroupBox.Visible = $true
        $resultsTabControl.Visible = $true

        $count = $script:loadedSnapshotData.Samples.Count
        $timelineTrackBar.Minimum = 0
        $timelineTrackBar.Maximum = [math]::Max(0, $count - 1)
        $timelineTrackBar.TickFrequency = 1
        $timelineTrackBar.SmallChange  = 1
        $timelineTrackBar.LargeChange  = 1
        $timelineTrackBar.Enabled = $true

        Build-TimelineLabels -samples $script:loadedSnapshotData.Samples

        $script:isUpdatingTimeline = $true
        $timelineTrackBar.Value = 0
        $script:isUpdatingTimeline = $false
        Set-TimelineIndex -index 0

        Log-Message "Snapshot loaded successfully."
    }
    catch {
        Log-Message "ERROR: Failed to load snapshot from DB. $_"
    }
}

# =======================
# CONTEXT MENU HANDLERS
# =======================
function Get-SelectedRowObjectFromGrid {
    param([System.Windows.Forms.DataGridView]$grid)
    if ($grid.SelectedRows.Count -gt 0) {
        return $grid.SelectedRows[0].DataBoundItem
    } elseif ($grid.CurrentRow -and $grid.CurrentRow.Index -ge 0) {
        return $grid.CurrentRow.DataBoundItem
    }
    return $null
}

function Copy-RowToClipboard {
    param([System.Windows.Forms.DataGridView]$grid)

    $rowObj = Get-SelectedRowObjectFromGrid -grid $grid
    if (-not $rowObj) { return }

    $sbHeader = New-Object System.Text.StringBuilder
    $sbValues = New-Object System.Text.StringBuilder

    foreach ($col in $grid.Columns) {
        if ($col.Visible) {
            [void]$sbHeader.Append($col.HeaderText)
            [void]$sbHeader.Append("`t")
            $val = ""
            try { $val = ($rowObj."$($col.DataPropertyName)") } catch {}
            [void]$sbValues.Append($val)
            [void]$sbValues.Append("`t")
        }
    }

    $text = ($sbHeader.ToString().Trim("`t") + "`r`n" + $sbValues.ToString().Trim("`t"))
    [System.Windows.Forms.Clipboard]::SetText($text)
    Log-Message "Row copied to clipboard."
}

function Show-ExecutionPlan {
    param([System.Windows.Forms.DataGridView]$grid)

    $rowObj = Get-SelectedRowObjectFromGrid -grid $grid
    if (-not $rowObj) { return }

    $planXml = $null
    try { $planXml = $rowObj.query_plan } catch { $planXml = $null }

    if (-not $planXml -or [string]::IsNullOrWhiteSpace([string]$planXml)) {
        [System.Windows.Forms.MessageBox]::Show(
            "No execution plan available for this row.",
            "SPOT",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Information
        ) | Out-Null
        return
    }

    $tempFile = [System.IO.Path]::Combine(
        [System.IO.Path]::GetTempPath(),
        ("SPOT_Plan_{0}.sqlplan" -f ([Guid]::NewGuid().ToString("N")))
    )

    try {
        [System.IO.File]::WriteAllText($tempFile, [System.Text.Encoding]::UTF8.GetString([System.Text.Encoding]::UTF8.GetBytes([string]$planXml)), [System.Text.Encoding]::UTF8)
        Start-Process $tempFile
        Log-Message "Execution plan opened: $tempFile"
    }
    catch {
        Log-Message "ERROR: Could not open execution plan. $($_.Exception.Message)"
        [System.Windows.Forms.MessageBox]::Show(
            "Could not open execution plan viewer on this machine.",
            "SPOT",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Error
        ) | Out-Null
    }
}

$menuCopyRow.Add_Click({
    $src = $gridContextMenu.SourceControl
    if ($src -is [System.Windows.Forms.DataGridView]) {
        Copy-RowToClipboard -grid $src
    }
})

$menuViewPlan.Add_Click({
    $src = $gridContextMenu.SourceControl
    if ($src -is [System.Windows.Forms.DataGridView]) {
        Show-ExecutionPlan -grid $src
    }
})

# =======================
# CONNECTION / CAPTURE / SESSION BUTTON HELPERS
# =======================
function Invoke-ConnectionTest {
    $server = $serverTextBox.Text
    $username = $usernameTextBox.Text
    $password = Get-PasswordFromTextBox
    $connectionString = "Server=$server;Database=master;User ID=$username;Password=$password;Connection Timeout=5;TrustServerCertificate=True"
    $connection = New-Object System.Data.SqlClient.SqlConnection($connectionString)
    try {
        Log-Message "Testing connection to $server..."
        $connection.Open()
        $connectionStatusLabel.Text = "Status: Connection Successful"
        $connectionStatusLabel.ForeColor = [System.Drawing.ColorTranslator]::FromHtml("#32CD32")
        $captureButton.Enabled = $true
        Log-Message "Connection to $server successful."
    }
    catch {
        $connectionStatusLabel.Text = "Status: Connection Failed"
        $connectionStatusLabel.ForeColor = [System.Drawing.ColorTranslator]::fromHtml("#FF4500")
        $captureButton.Enabled = $false
        Log-Message "ERROR: Failed to connect to '$server'. Exception: $($_.Exception.ToString())"
    }
    finally {
        if ($connection.State -eq 'Open') { $connection.Close() }
    }
}

# =======================
# BUTTON & MENU EVENTS
# =======================
$testConnectionButton.Add_Click({
    Invoke-ConnectionTest
})

function Prompt-ForSessionName {
    $dlg = New-Object System.Windows.Forms.Form
    $dlg.Text = "Save Session As"
    $dlg.Size = New-Object System.Drawing.Size(400,180)
    $dlg.StartPosition = "CenterParent"
    $dlg.BackColor = $bgMain
    $dlg.ForeColor = $fgPrimary
    $dlg.Font = $fontRegular
    $dlg.FormBorderStyle = 'FixedDialog'
    $dlg.MaximizeBox = $false
    $dlg.MinimizeBox = $false

    $lbl = New-Object System.Windows.Forms.Label
    $lbl.Text = "Session Name:"
    $lbl.AutoSize = $true
    $lbl.Location = New-Object System.Drawing.Point(15,20)
    $lbl.ForeColor = $fgPrimary

    $tb = New-Object System.Windows.Forms.TextBox
    $tb.Location = New-Object System.Drawing.Point(120,18)
    $tb.Size = New-Object System.Drawing.Size(250,20)
    $tb.BackColor = $gridRowBg
    $tb.ForeColor = $fgPrimary
    $tb.BorderStyle = 'FixedSingle'

    if (-not [string]::IsNullOrWhiteSpace($script:CurrentSessionName)) {
        $tb.Text = $script:CurrentSessionName
    }

    $okBtn = New-Object System.Windows.Forms.Button
    $okBtn.Text = 'Save'
    $okBtn.Width = 80
    $okBtn.Location = New-Object System.Drawing.Point(210,70)
    $okBtn.BackColor = $btnGray
    $okBtn.ForeColor = $fgPrimary
    $okBtn.FlatStyle = 'Flat'
    $okBtn.Font = $fontRegular

    $cancelBtn = New-Object System.Windows.Forms.Button
    $cancelBtn.Text = 'Cancel'
    $cancelBtn.Width = 80
    $cancelBtn.Location = New-Object System.Drawing.Point(300,70)
    $cancelBtn.BackColor = $btnGray
    $cancelBtn.ForeColor = $fgPrimary
    $cancelBtn.FlatStyle = 'Flat'
    $cancelBtn.Font = $fontRegular

    $dlg.Controls.AddRange(@($lbl,$tb,$okBtn,$cancelBtn))

    $okBtn.Add_Click({
        if (-not [string]::IsNullOrWhiteSpace($tb.Text)) {
            $dlg.Tag = $tb.Text
            $dlg.DialogResult = 'OK'
            $dlg.Close()
        }
    })
    $cancelBtn.Add_Click({
        $dlg.DialogResult = 'Cancel'
        $dlg.Close()
    })

    $res = $dlg.ShowDialog($mainForm)
    if ($res -eq 'OK') {
        return $dlg.Tag
    }
    return $null
}

$saveConnectionButton.Add_Click({
    $sessName = Prompt-ForSessionName
    if ([string]::IsNullOrWhiteSpace($sessName)) {
        Log-Message "Save Session cancelled."
        return
    }

    $securePwd = ($passwordTextBox.Text | ConvertTo-SecureString -AsPlainText -Force)
    Upsert-Session -Name $sessName `
        -Server $serverTextBox.Text `
        -Username $usernameTextBox.Text `
        -Password $securePwd

    $script:CurrentSessionName = $sessName
    $currentSessionValue.Text = $sessName
    Log-Message "Session '$sessName' saved to $script:SessionsFilePath"

    Populate-SessionDropdown
    $sessionComboBox.SelectedItem = $sessName
})

$deleteSessionButton.Add_Click({
    $nameToDelete = $script:CurrentSessionName
    if ([string]::IsNullOrWhiteSpace($nameToDelete)) {
        Log-Message "No active session to delete."
        return
    }

    $res = [System.Windows.Forms.MessageBox]::Show(
        "Delete session '$nameToDelete'?",
        "Confirm Delete",
        [System.Windows.Forms.MessageBoxButtons]::YesNo,
        [System.Windows.Forms.MessageBoxIcon]::Warning
    )

    if ($res -ne [System.Windows.Forms.DialogResult]::Yes) {
        Log-Message "Delete cancelled."
        return
    }

    Remove-SessionByName -Name $nameToDelete
    Log-Message "Session '$nameToDelete' deleted."

    # Reset UI state
    $serverTextBox.Text   = ""
    $usernameTextBox.Text = ""
    $passwordTextBox.Text = ""
    $passwordTextBox.Tag  = $null
    $currentSessionValue.Text = "(none)"
    $script:CurrentSessionName = $null

    $connectionStatusLabel.Text = "Status: Not Connected"
    $connectionStatusLabel.ForeColor = $fgSecondary
    $captureButton.Enabled = $false

    Populate-SessionDropdown

    # If any session remains, load first and test it
    if ($sessionComboBox.Items.Count -gt 0) {
        $sessionComboBox.SelectedIndex = 0
        $firstName = $sessionComboBox.SelectedItem
        $firstSession = Get-SessionByName -Name $firstName
        if ($firstSession) {
            $script:CurrentSessionName = $firstSession.Name
            $currentSessionValue.Text  = $firstSession.Name
            Set-UiFromSession -session $firstSession
            Save-AllSessions
            Log-Message "Session '$($firstSession.Name)' loaded after delete."
            Invoke-ConnectionTest
        }
    }
})

$sampleRateSlider.Add_ValueChanged({
    $sampleRateValueLabel.Text = $sampleRateSlider.Value
})
$numSamplesSlider.Add_ValueChanged({
    $numSamplesValueLabel.Text = $numSamplesSlider.Value
})

$captureButton.Add_Click({
    $captureButton.Enabled = $false
    $mainForm.Cursor = [System.Windows.Forms.Cursors]::WaitCursor
    try {
        $connStr = "Server=$($serverTextBox.Text);Database=utility;User ID=$($usernameTextBox.Text);Password=$(Get-PasswordFromTextBox);TrustServerCertificate=True"
        $sampleRate = $sampleRateSlider.Value
        $numSamples = $numSamplesSlider.Value
        $getPlans = 1

        Log-Message ("Executing SPOT - estimated runtime {0} seconds" -f ($numSamples * $sampleRate))

        $summary = Get-SqlData -ConnectionString $connStr -Query @"
EXEC SPOT.CaptureSnapshot
    @SampleCount       = $numSamples,
    @SampleTimeSeconds = $sampleRate,
    @GetPlans          = 1;
"@
        if (-not $summary -or $summary.Count -eq 0) {
            throw "Capture returned no summary output"
        }

        $snapId = [datetime]$summary[0].SnapshotId
        Log-Message "Capture complete. SnapshotId: $($snapId.ToString('yyyy-MM-dd HH:mm:ss.fff'))"
        Load-SnapshotById -ConnectionString $connStr -SnapshotId $snapId
    }
    catch {
        Log-Message "CAPTURE FAILED: $($_.Exception.ToString())"
    }
    finally {
        $mainForm.Cursor = [System.Windows.Forms.Cursors]::Default
        $captureButton.Enabled = $true
    }
})

$loadSnapshotButton.Add_Click({
    $connStr = "Server=$($serverTextBox.Text);Database=utility;User ID=$($usernameTextBox.Text);Password=$(Get-PasswordFromTextBox);TrustServerCertificate=True"
    Show-SnapshotPicker -ConnectionString $connStr
})

$saveSnapshotToFileButton.Add_Click({
    Save-SnapshotToFile
})

$loadSnapshotFromFileButton.Add_Click({
    Load-SnapshotFromFile
})

# Menu item hooks
$miStartCap.Add_Click({
    $captureButton.PerformClick()
})
$miLoadFromDB.Add_Click({
    $loadSnapshotButton.PerformClick()
})
$miLoadFromFile.Add_Click({
    Load-SnapshotFromFile
})
$miSaveToFile.Add_Click({
    Save-SnapshotToFile
})
$miExit.Add_Click({
    $mainForm.Close()
})

$miHowTo.Add_Click({
    $howToText = "HOW TO USE SPOT`r`n`r`n" +
        "1. Create or select a saved Session on the left, then click Test.`r`n" +
        "2. Set Sample Interval and Number of Samples.`r`n" +
        "3. Click Start Capture to collect performance data into the utility.SPOT tables.`r`n" +
        "4. Use 'Load Snapshot from DB' to browse a historical snapshot from SQL.`r`n" +
        "5. Use 'Save Snapshot to File' / 'Load Snapshot from File' to work offline.`r`n" +
        "6. Navigate samples using the timeline, and review each tab for waits,`r`n" +
        "   blocking, AG health, and health checks.`r`n`r`n" +
        "Tip: Red-highlighted rows in WhoIsActive mean possible blocking / pain."

    [System.Windows.Forms.MessageBox]::Show(
        $howToText,
        "SPOT - How To",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    ) | Out-Null
})


$miAbout.Add_Click({
    # --- constants / config ---
    $repoUrl = "https://github.com/jakemorgangit/SPOT"

    # --- form ---
    $about = New-Object System.Windows.Forms.Form
    $about.Text = "About SPOT"
    $about.Size = New-Object System.Drawing.Size(420,320)
    $about.StartPosition = "CenterParent"
    $about.BackColor = $bgMain
    $about.ForeColor = $fgPrimary
    $about.Font = $fontRegular
    $about.FormBorderStyle = 'FixedDialog'
    $about.MaximizeBox = $false
    $about.MinimizeBox = $false

   # --- version / author text ---
    $lblInfo = New-Object System.Windows.Forms.Label
    $lblInfo.AutoSize = $true
    $lblInfo.Location = New-Object System.Drawing.Point(20, 20)
    $lblInfo.ForeColor = $fgPrimary
    $lblInfo.Text = "SPOT $($script:SpotVersion)`r`nAuthor: $($script:SpotAuthor)"

    # --- link label for GitHub ---
    $linkLabel = New-Object System.Windows.Forms.LinkLabel
    $linkLabel.AutoSize = $true
    # place it dynamically just below $lblInfo
    $xPos = $lblInfo.Left
    $yPos = $lblInfo.Top + $lblInfo.PreferredHeight + 6
    $linkLabel.Location = New-Object System.Drawing.Point($xPos, $yPos)

    $linkLabel.LinkColor = $accentBlue
    $linkLabel.ActiveLinkColor = $fgAccent
    $linkLabel.VisitedLinkColor = $accentBlue
    $linkLabel.BackColor = $bgMain
    $linkLabel.ForeColor = $accentBlue
    $linkLabel.Text = "View on GitHub"
    $linkLabel.Tag = $repoUrl


    $linkLabel.add_LinkClicked({
        param($sender,$e)
        try {
            Start-Process $sender.Tag | Out-Null
        } catch {
            [System.Windows.Forms.MessageBox]::Show(
                "Couldn't open browser for $($sender.Tag)`r`n$($_.Exception.Message)",
                "SPOT",
                [System.Windows.Forms.MessageBoxButtons]::OK,
                [System.Windows.Forms.MessageBoxIcon]::Error
            ) | Out-Null
        }
    })

    # --- picture box (must exist before we try to load the image) ---
    $picLogo = New-Object System.Windows.Forms.PictureBox
    $picLogo.Location = New-Object System.Drawing.Point(20, 80)
    $picLogo.Size = New-Object System.Drawing.Size(200, 150)
    $picLogo.SizeMode = [System.Windows.Forms.PictureBoxSizeMode]::Zoom
    $picLogo.BorderStyle= 'FixedSingle'
    $picLogo.BackColor = $bgPanel

    # --- improved helper: decode data:image/...;base64,... into Image ---
    function Set-LogoFromBase64 {
        param([string]$dataUri)

        if ([string]::IsNullOrWhiteSpace($dataUri)) { return $false }

        # strip prefix like data:image/png;base64,
        $raw = $dataUri.Trim()
        if ($raw -match '^data:image/[^;]+;base64,') {
            $raw = $raw.Substring($raw.IndexOf(',') + 1)
        }

        try {
            $raw = $raw.Trim()  # remove stray whitespace/newlines
            $bytes = [Convert]::FromBase64String($raw)

            # load PNG bytes into a MemoryStream and rewind
            $ms = New-Object System.IO.MemoryStream(,$bytes)
            $ms.Position = 0

            # Bitmap gives cleaner failure behavior than Image.FromStream
            $img = [System.Drawing.Bitmap]::new($ms)

            if ($null -eq $img) { throw "Bitmap failed to load." }

            $picLogo.Image = $img
            return $true
        }
        catch {
            Log-Message "Set-LogoFromBase64: Failed to load image - $($_.Exception.Message)"
            return $false
        }
    }

    # --- try PNG first, then SVG fallback if you ever add it ---
    $loadedOk = $false
    if ($script:SpotLogoBase64Png) {
        $loadedOk = Set-LogoFromBase64 $script:SpotLogoBase64Png
    }
    if (-not $loadedOk -and $script:SpotLogoBase64Svg) {
        $loadedOk = Set-LogoFromBase64 $script:SpotLogoBase64Svg
    }

    # --- fallback message only if we totally failed ---
    $fallbackLbl = $null
    if (-not $loadedOk) {
        $fallbackLbl = New-Object System.Windows.Forms.Label
        $fallbackLbl.AutoSize = $true
        $fallbackLbl.Location = New-Object System.Drawing.Point(25,150)
        $fallbackLbl.ForeColor = $fgSecondary
        $fallbackLbl.Text = "(logo could not be loaded)"
    }

    # --- OK button ---
    $okBtn = New-Object System.Windows.Forms.Button
    $okBtn.Text = "OK"
    $okBtn.Width = 80
    $okBtn.Location = New-Object System.Drawing.Point(310,240)
    $okBtn.BackColor = $btnGray
    $okBtn.ForeColor = $fgPrimary
    $okBtn.FlatStyle = 'Flat'
    $okBtn.Font = $fontRegular
    $okBtn.Add_Click({ $about.Close() })

    # --- add controls to form ---
    if ($fallbackLbl) {
        $about.Controls.AddRange(@(
            $lblInfo,
            $linkLabel,
            $picLogo,
            $fallbackLbl,
            $okBtn
        ))
    }
    else {
        $about.Controls.AddRange(@(
            $lblInfo,
            $linkLabel,
            $picLogo,
            $okBtn
        ))
    }

    # --- show dialog ---
    [void]$about.ShowDialog($mainForm)
})





# =======================
# SNAPSHOT PICKER DIALOG
# =======================
function Show-SnapshotPicker {
    param([string]$ConnectionString)

    $dlg = New-Object System.Windows.Forms.Form
    $dlg.Text = "Choose Snapshot"
    $dlg.Size = New-Object System.Drawing.Size(760, 460)
    $dlg.StartPosition = "CenterParent"
    $dlg.BackColor = $bgMain
    $dlg.ForeColor = $fgPrimary
    $dlg.Font = $fontRegular

    $lv = New-Object System.Windows.Forms.ListView
    $lv.View = 'Details'
    $lv.FullRowSelect = $true
    $lv.HideSelection = $false
    $lv.GridLines = $true
    $lv.Dock = 'Top'
    $lv.Height = 340
    $lv.BackColor = $gridRowBg
    $lv.ForeColor = $fgPrimary
    $lv.Font = $fontRegular

    [void]$lv.Columns.Add("SnapshotId",          170)
    [void]$lv.Columns.Add("StartedAtUtc",        150)
    [void]$lv.Columns.Add("ServerName",          130)
    [void]$lv.Columns.Add("SampleCount",          90)
    [void]$lv.Columns.Add("SampleTimeSeconds",   120)
    [void]$lv.Columns.Add("GetPlans",             70)

    $statusLbl = New-Object System.Windows.Forms.Label
    $statusLbl.Text = "Querying..."
    $statusLbl.AutoSize = $true
    $statusLbl.Location = New-Object System.Drawing.Point(10, 345)
    $statusLbl.ForeColor = $fgPrimary
    $statusLbl.Font = $fontRegular

    $refreshBtn = New-Object System.Windows.Forms.Button
    $refreshBtn.Text = 'Refresh'
    $refreshBtn.Width = 100
    $refreshBtn.Location = New-Object System.Drawing.Point(410, 380)
    $refreshBtn.BackColor = $btnGray
    $refreshBtn.ForeColor = $fgPrimary
    $refreshBtn.FlatStyle = 'Flat'
    $refreshBtn.Font = $fontRegular

    $okBtn = New-Object System.Windows.Forms.Button
    $okBtn.Text = 'Load'
    $okBtn.Width = 100
    $okBtn.Location = New-Object System.Drawing.Point(520, 380)
    $okBtn.BackColor = $btnGray
    $okBtn.ForeColor = $fgPrimary
    $okBtn.FlatStyle = 'Flat'
    $okBtn.Font = $fontRegular

    $cancelBtn = New-Object System.Windows.Forms.Button
    $cancelBtn.Text = 'Cancel'
    $cancelBtn.Width = 100
    $cancelBtn.Location = New-Object System.Drawing.Point(630, 380)
    $cancelBtn.BackColor = $btnGray
    $cancelBtn.ForeColor = $fgPrimary
    $cancelBtn.FlatStyle = 'Flat'
    $cancelBtn.Font = $fontRegular

    $dlg.Controls.AddRange(@($lv, $statusLbl, $refreshBtn, $okBtn, $cancelBtn))

    $query = @"
SELECT TOP 200
       SnapshotId,
       StartedAtUtc,
       ServerName,
       SampleCount,
       SampleTimeSeconds,
       GetPlans
FROM SPOT.Snapshots
ORDER BY StartedAtUtc DESC;
"@

    $load = {
        try {
            $statusLbl.Text = "Querying..."
            $lv.BeginUpdate()
            $lv.Items.Clear()

            $rows = Get-SqlData -ConnectionString $ConnectionString -Query $query
            if (-not $rows -or $rows.Count -eq 0) {
                $statusLbl.Text = "No snapshots found."
            } else {
                foreach ($r in $rows) {
                    $snapStr  = ([datetime]$r.SnapshotId).ToString('yyyy-MM-dd HH:mm:ss.fff')
                    $startStr = ([datetime]$r.StartedAtUtc).ToString('yyyy-MM-dd HH:mm:ss.fff')
                    $srv      = [string]$r.ServerName
                    $cnt      = [string]$r.SampleCount
                    $secs     = [string]$r.SampleTimeSeconds
                    $gp       = if ([int]$r.GetPlans -eq 1) { '1' } else { '0' }

                    $item = New-Object System.Windows.Forms.ListViewItem($snapStr)
                    [void]$item.SubItems.Add($startStr)
                    [void]$item.SubItems.Add($srv)
                    [void]$item.SubItems.Add($cnt)
                    [void]$item.SubItems.Add($secs)
                    [void]$item.SubItems.Add($gp)

                    $item.Tag = [datetime]$r.SnapshotId
                    [void]$lv.Items.Add($item)
                }
                $statusLbl.Text = ("Loaded {0} snapshots" -f $rows.Count)
            }
        }
        catch {
            $statusLbl.Text = "Error querying snapshots (see console)"
            Log-Message "ERROR: Could not query SPOT.Snapshots. $($_.Exception.Message)"
        }
        finally {
            $lv.EndUpdate()
        }
    }

    & $load
    $refreshBtn.Add_Click({ & $load })

    $okBtn.Add_Click({
        if ($lv.SelectedItems.Count -gt 0) {
            $dlg.DialogResult = 'OK'
            $dlg.Close()
        }
    })

    $cancelBtn.Add_Click({
        $dlg.DialogResult = 'Cancel'
        $dlg.Close()
    })

    if ($dlg.ShowDialog($mainForm) -eq 'OK' -and $lv.SelectedItems.Count -gt 0) {
        $snapId = [datetime]$lv.SelectedItems[0].Tag
        $connStr = "Server=$($serverTextBox.Text);Database=utility;User ID=$($usernameTextBox.Text);Password=$(Get-PasswordFromTextBox);TrustServerCertificate=True"
        Load-SnapshotById -ConnectionString $connStr -SnapshotId $snapId
    }
}

# =======================
# TIMELINE SLIDER EVENT
# =======================
$timelineTrackBar.Add_ValueChanged({
    if ($script:isUpdatingTimeline) { return }
    Set-TimelineIndex -index $timelineTrackBar.Value
})

# =======================
# SESSION COMBO EVENTS
# =======================
$sessionComboBox.add_SelectedIndexChanged({
    $chosenName = $sessionComboBox.SelectedItem
    if ([string]::IsNullOrWhiteSpace($chosenName)) { return }

    $chosenSession = Get-SessionByName -Name $chosenName
    if ($chosenSession) {
        $script:CurrentSessionName = $chosenSession.Name
        $currentSessionValue.Text  = $chosenSession.Name
        Set-UiFromSession -session $chosenSession
        Save-AllSessions
        Log-Message "Session '$($chosenSession.Name)' loaded from selector."
        Invoke-ConnectionTest
    }
})

# =======================
# SESSION DROPDOWN POPULATION
# =======================
function Populate-SessionDropdown {
    Ensure-SessionsArrayList

    $sessionComboBox.Items.Clear()

    foreach ($s in $script:Sessions) {
        [void]$sessionComboBox.Items.Add($s.Name)
    }

    if ($sessionComboBox.Items.Count -gt 0) {
        if (-not [string]::IsNullOrWhiteSpace($script:CurrentSessionName) -and
            $sessionComboBox.Items.Contains($script:CurrentSessionName)) {

            $sessionComboBox.SelectedItem = $script:CurrentSessionName
        }
        else {
            $sessionComboBox.SelectedIndex = 0
        }
    }
    else {
        # no sessions: leave dropdown blank & enabled for visual consistency
        $sessionComboBox.Text = ""
    }
}

# =======================
# FORM LIFECYCLE
# =======================
$mainForm.Add_Shown({
    Load-AllSessions
    Load-SavedConnection
    Populate-SessionDropdown

    if (-not [string]::IsNullOrWhiteSpace($script:CurrentSessionName)) {
        $currentSessionValue.Text = $script:CurrentSessionName
    } else {
        $currentSessionValue.Text = "(none)"
    }

    Load-LastSessionToUi
})

[void]$mainForm.ShowDialog()
$mainForm.Dispose()

'@

Set-Content -Path $spotPath -Value $spotContent -Encoding UTF8

# -----------------------------
# Write Desktop launcher
# -----------------------------
$launcherContent = @'
# Launch-SPOT.ps1

$scriptPath = Join-Path $env:USERPROFILE "Documents\SQL Performance Observation Tool\SPOT.ps1"

if (Test-Path $scriptPath) {
    Start-Process powershell -ArgumentList "-NoProfile -ExecutionPolicy Bypass -File `"$scriptPath`""
} else {
    Write-Host "SPOT script not found at: $scriptPath" -ForegroundColor Red
}
'@

Set-Content -Path $launcher -Value $launcherContent -Encoding UTF8

Write-Host "Deployed SPOT to: $spotPath" -ForegroundColor Green
Write-Host "Desktop launcher created: $launcher" -ForegroundColor Green
